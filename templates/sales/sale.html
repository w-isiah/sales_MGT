{% extends 'base.html' %}

{% block content %}

<!-- Point of Sale Card -->
<div class="card mb-4">
  <div class="card-header">
    <h3 class="card-title">Point of Sale</h3>
    
    <div class="card-tools">
      <div class="btn-group mb-2" role="group" aria-label="Basic outlined example">
        <a href="/sales_view">
          <button type="button" class="btn btn-sm btn-outline-primary">View Sales</button>
        </a>
        <a href="/restock_product">
          <button type="button" class="btn btn-sm btn-outline-primary">Restock</button>
        </a>
        <a href="/discount_percentage">
          <button type="button" class="btn btn-sm btn-outline-primary">Calculate Discount (%)</button>
        </a>
      </div>
    </div>
  </div> <!-- /.card-header -->

  <div class="card-body">
    <!-- POS Content Block -->
    <div class="row">
      <!-- Left Section: Customer & Product Selection -->
      <div class="col-md-4">
        <form id="pos-form">
          
          <!-- Customer Selection -->
          <div class="control-group mb-3">
            <label for="customer-id" class="control-label">Customer</label>
            <div class="controls">
              <select id="customer-id" name="customer-id" class="form-control">
                <option value="" disabled selected>Select Customer</option>
                {% for i in customers %}
                  <option value="{{ i.CustomerID }}">{{ i.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Product Selection -->
          <div class="control-group mb-3">
            <label for="product-id" class="control-label">Product</label>
            <div class="controls">
              <select id="product-id" name="product-id" class="form-control">
                <option value="" disabled selected>Select Product</option>
                {% for i in products %}
                  <option data-available="{{ i.quantity }}" data-price="{{ i.price }}" value="{{ i.ProductID }}">{{ i.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Quantity Input -->
          <div class="control-group mb-3">
            <label for="product-qty" class="control-label">Quantity</label>
            <div class="controls">
              <input id="product-qty" type="number" min="1" name="quantity" class="form-control" placeholder="Enter Quantity" required>
              <!-- Display the available quantity dynamically -->
              <small id="available-qty-info" class="form-text text-muted">Available: 0</small>
            </div>
          </div>

          <!-- Discount Input -->
          <div class="control-group mb-3">
            <label for="discount" class="control-label">Discount (%)</label>
            <div class="controls">
              <input id="discount" type="number" min="0" max="100" name="discount" class="form-control" placeholder="Enter Discount Percentage" step="0.01">
            </div>
          </div>

          <!-- Add Item Button -->
          <div class="form-actions">
            <button type="button" id="add_item" class="btn btn-sm btn-primary" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">Add to Cart</button> 
          </div>

        </form>
      </div>

      <!-- Right Section: Cart Summary -->
      <div class="col-md-8">
        <h4>Cart Summary</h4>
        <div id="cart-list">
          <!-- Cart Table -->
          <table id="cart-table" class="table table-striped mb-3">
            <thead>
              <tr>
                <th style="width: 30%;">Product</th>
                <th style="width: 20%;">Quantity</th>
                <th style="width: 20%;">Total Price</th>
                <th style="width: 20%;">Discount (%)</th>
                <th style="width: 20%;">Discounted Price</th>
              </tr>
            </thead>
            <tbody id="item-list">
              <!-- Items will be dynamically added here -->
            </tbody>
          </table>

          <!-- Total Price Display -->
          <div class="total-price">
            <strong>Total: </strong><span id="total-price">0.00/=</span>
          </div>

          <!-- Amount Tendered Input -->
          <div class="control-group mb-3">
            <label for="amount-tendered" class="control-label">Amount Tendered</label>
            <div class="controls">
              <input id="amount-tendered" type="number" min="0" name="amount-tendered" class="form-control" placeholder="Enter Amount Tendered" step="0.01">
            </div>
          </div>

          <!-- Change Display -->
          <div class="total-price">
            <strong>Change: </strong><span id="change">0.00/=</span>
          </div>

          <!-- Checkout Button -->
          <div class="form-actions">
            <button type="button" id="checkout" style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;" class="btn btn-sm btn-success">Checkout</button>
          </div>

        </div>
      </div>
    </div>
  </div> <!-- /.card-body -->
</div> <!-- /.card -->

<!-- JavaScript Block -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    let totalAmount = 0; // Variable to keep track of total price

    // Handle product selection
    $('#product-id').change(function() {
      const selectedOption = $(this).find('option:selected');
      const availableQty = selectedOption.data('available');
      const price = selectedOption.data('price');

      // Display available quantity
      $('#available-qty-info').text(`Available: ${availableQty}`);

      // Set the max value of the quantity input to the available quantity
      $('#product-qty').attr('max', availableQty);
    });

    // Handle Add to Cart button click
    $('#add_item').click(function() {
      const productSelect = $('#product-id');
      const quantityInput = $('#product-qty');
      const quantity = parseInt(quantityInput.val(), 10);
      const discountInput = $('#discount');
      const discount = parseFloat(discountInput.val()) || 0;

      const selectedOption = productSelect.find('option:selected');
      const productName = selectedOption.text();
      const availableQty = selectedOption.data('available');
      const price = selectedOption.data('price');

      if (!productName) {
        alert("Please select a product.");
        return;
      }

      // Validate quantity
      if (isNaN(quantity) || quantity < 1 || quantity > availableQty) {
        alert(`Invalid quantity. Please enter a valid quantity between 1 and ${availableQty}.`);
        return;
      }

      // Validate price
      if (price == null || price == undefined || price <= 0) {
        alert("Invalid product price. Please select a valid product.");
        return;
      }

      // Calculate total price for the item
      const totalPrice = price * quantity;

      // Apply discount
      const discountAmount = (totalPrice * discount) / 100;
      const discountedPrice = totalPrice - discountAmount;

      // Add item to the cart table
      const row = $('<tr></tr>')
        .data('product-id', selectedOption.val())  // Store the ProductID for later use
        .append(`<td>${productName}</td>`)
        .append(`<td class="item-quantity">${quantity}</td>`)  <!-- Display Quantity -->
        .append(`<td class="price">${totalPrice.toFixed(2)}/=</td>`)
        .append(`<td class="item-discount">${discount.toFixed(2)}%</td>`)
        .append(`<td class="discounted-price">$${discountedPrice.toFixed(2)}</td>`);

      $('#item-list').append(row);

      // Update total amount
      totalAmount += discountedPrice;
      $('#total-price').text(`${totalAmount.toFixed(2)}/=`);

      // Reset the quantity and discount inputs after adding the item
      quantityInput.val('');
      discountInput.val('');
    });

    // Handle Amount Tendered input change and calculate Change
    $('#amount-tendered').keyup(function() {
      const amountTendered = parseFloat($(this).val()) || 0;
      const change = amountTendered - totalAmount;
      if (change < 0) {
        $('#change').text(`$0.00`); // No negative change
      } else {
        $('#change').text(`$${change.toFixed(2)}`);
      }
    });

    // Handle Checkout button click
    $('#checkout').click(function() {
      if (totalAmount > 0) {
        const amountTendered = parseFloat($('#amount-tendered').val()) || 0;
        if (amountTendered < totalAmount) {
          alert('Insufficient amount tendered. Please enter a sufficient amount.');
        } else {
          const customerID = $('#customer-id').val();
          const cartItems = [];
          
          $('#cart-table tbody tr').each(function () {
            const productID = $(this).data('product-id');
            const quantity = parseInt($(this).find('.item-quantity').text());
            const price = parseFloat($(this).find('.price').text().replace('$', ''));
            const discount = parseFloat($(this).find('.item-discount').text().replace('%', ''));
            const discountedPrice = parseFloat($(this).find('.discounted-price').text().replace('$', ''));
            
            cartItems.push({
              product_id: productID,
              quantity: quantity,
              price: price,
              discount: discount,
              total_price: price * quantity,
              discounted_price: discountedPrice
            });
          });

          $.ajax({
            url: '/save_sale',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              customer_id: customerID,
              cart_items: cartItems,
              total_price: totalAmount,
              discounted_price: totalAmount // assuming no extra discount for whole sale
            }),
            success: function(response) {
              alert(response.message);
              // Reset the form and cart after successful checkout
              $('#pos-form')[0].reset();
              $('#item-list').empty();
              $('#total-price').text('$0.00');
              $('#change').text('$0.00');
            },
            error: function(error) {
              alert('Error: ' + error.responseJSON.message);
            }
          });
        }
      } else {
        alert('No items in the cart.');
      }
    });
  });
</script>

{% endblock %}
